<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VT Seva Branch Funding Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body{font-family:Arial,Helvetica,sans-serif;background:#f4f7fa;color:#333;margin:0;padding:0;}
        .container{max-width:1000px;margin:30px auto;padding:20px;background:#fff;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,.1);}
        h1{text-align:center;color:#2c3e50;}
        .upload{margin:20px 0;text-align:center;}
        .config-box, .pledge-box{margin:20px 0;padding:15px;background:#f0f8ff;border-radius:6px;}
        .config-box h3, .pledge-box h3{margin-top:0;color:#1a73e8;}
        .input-group{max-width:300px;margin:0 auto;}
        .input-group label{font-weight:bold;display:block;margin-bottom:5px;color:#2c3e50;}
        .input-group input{width:100%;padding:8px;font-size:1rem;border:1px solid #81c784;border-radius:4px;}
        .summary{display:flex;justify-content:space-around;flex-wrap:wrap;margin:30px 0;}
        .box{background:#e9f5ff;padding:15px;border-radius:6px;text-align:center;flex:1 1 160px;margin:10px;}
        .box h3{margin:0 0 8px;font-size:1.1rem;color:#2c3e50;}
        .box p{font-size:1.8rem;margin:0;color:#1a73e8;font-weight:bold;}
        .box.pledge p{color:#2e7d32;}
        .box.goal p{color:#f57c00;}
        .charts{display:flex;flex-wrap:wrap;gap:30px;justify-content:center;margin:40px 0;}
        .chart-box{flex:1 1 420px;background:#fff;padding:20px;border-radius:6px;box-shadow:0 1px 6px rgba(0,0,0,.1);}
        #thermometer{position:relative;height:340px;width:80px;margin:0 auto;background:#eee;border-radius:40px;overflow:hidden;}
        #fill{position:absolute;bottom:0;width:100%;background:linear-gradient(#ff5f6d,#ffc371);transition:height .6s ease;}
        #goal-line{position:absolute;width:100%;height:2px;background:#333;left:0;}
        .label{position:absolute;width:220px;left:100px;font-weight:bold;}
        .hidden{display:none;}
        .note{font-size:0.9rem;color:#666;text-align:center;margin-top:5px;}
    </style>
    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">
    <h1>VT Seva Branch Funding Tracker</h1>
    <p style="text-align:center;">Track donations + pledges → sponsor children at <strong>$365 each</strong>.</p>

    <!-- Goal Kids Input -->
    <div class="config-box">
        <h3>Campaign Goal</h3>
        <div class="input-group">
            <label for="goalKids">Children to Sponsor</label>
            <input type="number" id="goalKids" min="1" step="1" placeholder="800">
        </div>
        <p class="note">Goal Amount = <span id="goalCalc">800 × $365 = $292,000</span></p>
    </div>

    <div class="upload">
        <input type="file" id="excelFile" accept=".xlsx,.xls">
        <p><small>Upload donations file (Sheet5 must have <code>Jan - Dec 25</code> column)</small></p>
    </div>

    <!-- Pledges -->
    <div class="pledge-box">
        <h3>Add Known Pledges (not in file)</h3>
        <input type="number" id="pledges" placeholder="e.g. 5000" min="0" step="1">
        <p class="note">Saved locally — survives page refresh</p>
    </div>

    <div class="summary">
        <div class="box">
            <h3>Donations (File)</h3>
            <p id="donationsOnly">$0</p>
        </div>
        <div class="box pledge">
            <h3>Pledges (Manual)</h3>
            <p id="pledgesDisplay">$0</p>
        </div>
        <div class="box">
            <h3>Total Raised</h3>
            <p id="totalRaised">$0</p>
        </div>
        <div class="box goal">
            <h3>Goal Amount</h3>
            <p id="goalAmount">$292,000</p>
        </div>
        <div class="box">
            <h3>Children Sponsored</h3>
            <p id="kidsSponsored">0</p>
        </div>
    </div>

    <div class="charts">
        <!-- Thermometer -->
        <div class="chart-box">
            <h3 style="text-align:center;margin-bottom:10px;">Progress Thermometer</h3>
            <div id="thermometer">
                <div id="fill"></div>
                <div id="goal-line" style="bottom:100%;"></div>
                <div class="label" id="goalLabel" style="bottom:calc(100% - 12px);">Goal $292,000</div>
                <div class="label" id="currentLabel" style="bottom:0;">$0</div>
            </div>
        </div>

        <!-- Bar Chart -->
        <div class="chart-box">
            <h3 style="text-align:center;margin-bottom:10px;">Donations by Category (File Only)</h3>
            <canvas id="barChart"></canvas>
        </div>
    </div>

    <p class="hidden" id="error" style="color:#d32f2f;text-align:center;"></p>
</div>

<script>
/* ---------- CONSTANTS ---------- */
const COST_PER_CHILD = 365;
const STORAGE_KEY_GOAL = 'campaign_goalKids';
const STORAGE_KEY_PLEDGES = 'campaign_pledges';

/* ---------- STATE ---------- */
let donationsFromFile = 0;
let pledges = 0;
let goalKids = 800;

/* ---------- DOM Elements ---------- */
const goalKidsInput     = document.getElementById('goalKids');
const pledgesInput      = document.getElementById('pledges');
const fileInput         = document.getElementById('excelFile');

const donationsEl       = document.getElementById('donationsOnly');
const pledgesEl         = document.getElementById('pledgesDisplay');
const totalEl           = document.getElementById('totalRaised');
const goalAmountEl      = document.getElementById('goalAmount');
const kidsEl            = document.getElementById('kidsSponsored');
const goalCalcEl        = document.getElementById('goalCalc');

const fillEl            = document.getElementById('fill');
const goalLabelEl       = document.getElementById('goalLabel');
const curLabelEl        = document.getElementById('currentLabel');
const errEl             = document.getElementById('error');

let barChart;
const COLORS = ['#ff6384','#36a2eb','#ffce56','#4bc0c0','#9966ff','#ff9f40'];

/* ---------- Helpers ---------- */
function formatMoney(v) { return '$' + Math.floor(v).toLocaleString(); }
function safeTrim(val) { return val == null ? '' : String(val).trim(); }
function save(key, value) { localStorage.setItem(key, value); }
function load(key, fallback) { return localStorage.getItem(key) || fallback; }

/* ---------- Calculate Goal ---------- */
function getGoal() { return goalKids * COST_PER_CHILD; }

/* ---------- Update UI ---------- */
function updateAll() {
    const total = donationsFromFile + pledges;
    const goal = getGoal();

    donationsEl.textContent = formatMoney(donationsFromFile);
    pledgesEl.textContent = formatMoney(pledges);
    totalEl.textContent = formatMoney(total);
    goalAmountEl.textContent = formatMoney(goal);
    kidsEl.textContent = Math.floor(total / COST_PER_CHILD);
    goalCalcEl.textContent = `${goalKids} × $${COST_PER_CHILD} = ${formatMoney(goal)}`;

    const percent = goal > 0 ? Math.min((total / goal) * 100, 100) : 0;
    fillEl.style.height = percent + '%';
    curLabelEl.textContent = formatMoney(total);
    curLabelEl.style.bottom = (percent > 5 ? percent - 3 : percent + 1) + '%';
    goalLabelEl.textContent = `Goal ${formatMoney(goal)}`;
}

/* ---------- Load Settings ---------- */
function loadSettings() {
    goalKids = parseInt(load(STORAGE_KEY_GOAL, '800'), 10) || 800;
    pledges = parseFloat(load(STORAGE_KEY_PLEDGES, '0')) || 0;

    goalKidsInput.value = goalKids;
    pledgesInput.value = pledges > 0 ? pledges : '';
    updateAll();
}

/* ---------- Input Handlers ---------- */
goalKidsInput.addEventListener('input', () => {
    const val = parseInt(goalKidsInput.value, 10);
    if (val >= 1) {
        goalKids = val;
        save(STORAGE_KEY_GOAL, goalKids);
        updateAll();
    }
});

pledgesInput.addEventListener('input', () => {
    const val = parseFloat(pledgesInput.value) || 0;
    if (val >= 0) {
        pledges = val;
        save(STORAGE_KEY_PLEDGES, pledges);
        updateAll();
    }
});

/* ---------- Bar Chart ---------- */
function renderBar(data) {
    const ctx = document.getElementById('barChart').getContext('2d');
    if (barChart) barChart.destroy();

    const labels = Object.keys(data);
    const values = Object.values(data);

    barChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Donations ($)',
                data: values,
                backgroundColor: COLORS.slice(0, labels.length),
                borderColor: '#333',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `$${ctx.parsed.y.toLocaleString()}`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: v => '$' + v.toLocaleString() }
                }
            }
        }
    });
}

/* ---------- Excel Processing ---------- */
fileInput.addEventListener('change', e => {
    errEl.classList.add('hidden');
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
        try {
            const data = new Uint8Array(ev.target.result);
            const workbook = XLSX.read(data, {type: 'array'});

            if (workbook.SheetNames.length < 5) throw new Error('Sheet5 not found');
            const sheet = workbook.Sheets[workbook.SheetNames[4]];  // Sheet5
            const json = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ''});

            const headerRow = json[3];
            const totalColIdx = headerRow.indexOf('Jan - Dec 25');
            if (totalColIdx === -1) throw new Error('"Jan - Dec 25" column not found in Sheet5');

            let total = 0;
            const categoryMap = {};

            // Skip last 3 rows
            for (let i = 4; i < json.length - 3; i++) {
                const row = json[i];
                const totalVal = parseFloat(row[totalColIdx]);
                if (!isNaN(totalVal) && totalVal > 0) {
                    total += totalVal;

                    const catCell = row[2];  // Column C (index 2)
                    const cat = safeTrim(catCell);
                    if (cat) {
                        categoryMap[cat] = (categoryMap[cat] || 0) + totalVal;
                    }
                }
            }

            donationsFromFile = total;
            updateAll();
            renderBar(categoryMap);

        } catch (err) {
            errEl.textContent = 'Error: ' + err.message;
            errEl.classList.remove('hidden');
            console.error(err);
        }
    };
    reader.readAsArrayBuffer(file);
});

/* ---------- Init ---------- */
loadSettings();
</script>
</body>
</html>
