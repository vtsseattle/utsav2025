<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VT Seva Seattle – 2025 Education Campaign</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body{font-family:Arial,Helvetica,sans-serif;background:#f4f7fa;color:#333;margin:0;padding:0;}
        .container{max-width:960px;margin:30px auto;padding:20px;background:#fff;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,.1);}
        h1{text-align:center;color:#2c3e50;}
        .upload{margin:20px 0;text-align:center;}
        .pledge-box{margin:20px 0;padding:15px;background:#e8f5e9;border-radius:6px;}
        .pledge-box label{font-weight:bold;display:block;margin-bottom:8px;color:#2e7d32;}
        .pledge-box input{width:100%;padding:10px;font-size:1.1rem;border:1px solid #81c784;border-radius:4px;}
        .summary{display:flex;justify-content:space-around;flex-wrap:wrap;margin:30px 0;}
        .box{background:#e9f5ff;padding:15px;border-radius:6px;text-align:center;flex:1 1 180px;margin:10px;}
        .box h3{margin:0 0 8px;font-size:1.1rem;color:#2c3e50;}
        .box p{font-size:1.8rem;margin:0;color:#1a73e8;font-weight:bold;}
        .box.pledge p{color:#2e7d32;}
        .charts{display:flex;flex-wrap:wrap;gap:30px;justify-content:center;}
        .chart-box{flex:1 1 400px;background:#fff;padding:15px;border-radius:6px;box-shadow:0 1px 6px rgba(0,0,0,.1);}
        #thermometer{position:relative;height:340px;width:80px;margin:0 auto;background:#eee;border-radius:40px;overflow:hidden;}
        #fill{position:absolute;bottom:0;width:100%;background:linear-gradient(#ff5f6d,#ffc371);transition:height .6s ease;}
        #goal-line{position:absolute;width:100%;height:2px;background:#333;left:0;}
        .label{position:absolute;width:200px;left:100px;font-weight:bold;}
        .hidden{display:none;}
        .note{font-size:0.9rem;color:#666;text-align:center;margin-top:5px;}
    </style>
    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">
    <h1>VT Seva Seattle – 2025 Education Campaign</h1>
    <p style="text-align:center;">Help us sponsor education for <strong>800 children</strong> – $365 per child.</p>

    <div class="upload">
        <input type="file" id="excelFile" accept=".xlsx,.xls">
        <p><small>Upload <code>Seattle - 09302025.xlsx</code> (or any updated file)</small></p>
    </div>

    <!-- Pledges Input -->
    <div class="pledge-box">
        <label for="pledges">Add Known Pledges (not in file yet)</label>
        <input type="number" id="pledges" placeholder="e.g. 5000" min="0" step="1">
        <p class="note">This amount is saved locally and added to total raised.</p>
    </div>

    <div class="summary">
        <div class="box">
            <h3>Donations (from file)</h3>
            <p id="donationsOnly">$0</p>
        </div>
        <div class="box pledge">
            <h3>Pledges (manual)</h3>
            <p id="pledgesDisplay">$0</p>
        </div>
        <div class="box">
            <h3>Total Raised</h3>
            <p id="totalRaised">$0</p>
        </div>
        <div class="box">
            <h3>Goal</h3>
            <p>$292,000</p>
        </div>
        <div class="box">
            <h3>Children Sponsored</h3>
            <p id="kidsSponsored">0</p>
        </div>
    </div>

    <div class="charts">
        <!-- Thermometer -->
        <div class="chart-box">
            <h3 style="text-align:center;margin-bottom:10px;">Progress Thermometer (Total)</h3>
            <div id="thermometer">
                <div id="fill"></div>
                <div id="goal-line" style="bottom:100%;"></div>
                <div class="label" id="goalLabel" style="bottom:calc(100% - 12px);">Goal $292,000</div>
                <div class="label" id="currentLabel" style="bottom:0;">$0</div>
            </div>
        </div>

        <!-- Pie chart -->
        <div class="chart-box">
            <h3 style="text-align:center;margin-bottom:10px;">Donations by Category (File Only)</h3>
            <canvas id="pieChart"></canvas>
        </div>
    </div>

    <p class="hidden" id="error" style="color:#d32f2f;text-align:center;"></p>
</div>

<script>
/* ---------- CONFIG ---------- */
const GOAL = 800 * 365;  // $292,000
const COST_PER_CHILD = 365;
const COLORS = ['#ff6384','#36a2eb','#ffce56','#4bc0c0','#9966ff','#ff9f40'];

/* ---------- DOM Elements ---------- */
const fileInput       = document.getElementById('excelFile');
const pledgesInput    = document.getElementById('pledges');
const donationsEl     = document.getElementById('donationsOnly');
const pledgesEl       = document.getElementById('pledgesDisplay');
const totalEl         = document.getElementById('totalRaised');
const kidsEl          = document.getElementById('kidsSponsored');
const fillEl          = document.getElementById('fill');
const curLabelEl      = document.getElementById('currentLabel');
const errEl           = document.getElementById('error');
let pieChart;
let donationsFromFile = 0;
let pledges = 0;

/* ---------- Helpers ---------- */
function formatMoney(v){ return '$'+Math.floor(v).toLocaleString(); }
function safeTrim(val){
    if (val === null || val === undefined) return '';
    return String(val).trim();
}
function savePledges(){ localStorage.setItem('vtseva_pledges', pledges); }
function loadPledges(){ return parseFloat(localStorage.getItem('vtseva_pledges')) || 0; }

/* ---------- Update UI ---------- */
function updateAll() {
    const total = donationsFromFile + pledges;

    donationsEl.textContent = formatMoney(donationsFromFile);
    pledgesEl.textContent = formatMoney(pledges);
    totalEl.textContent = formatMoney(total);
    kidsEl.textContent = Math.floor(total / COST_PER_CHILD);

    // Thermometer: based on TOTAL
    const percent = Math.min((total / GOAL) * 100, 100);
    fillEl.style.height = percent + '%';
    curLabelEl.textContent = formatMoney(total);
    curLabelEl.style.bottom = (percent > 5 ? percent - 3 : percent + 1) + '%';
}

/* ---------- Thermometer ---------- */
function updateThermometer(amount){
    const percent = Math.min((amount / GOAL) * 100, 100);
    fillEl.style.height = percent + '%';
    curLabelEl.textContent = formatMoney(amount);
    curLabelEl.style.bottom = (percent > 5 ? percent-3 : percent+1) + '%';
}

/* ---------- Pie Chart (Donations Only) ---------- */
function renderPie(data){
    const ctx = document.getElementById('pieChart').getContext('2d');
    if(pieChart) pieChart.destroy();
    pieChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(data),
            datasets: [{ data: Object.values(data), backgroundColor: COLORS }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } }
        }
    });
}

/* ---------- Pledges Handler ---------- */
pledgesInput.addEventListener('input', () => {
    const val = parseFloat(pledgesInput.value) || 0;
    if (val >= 0) {
        pledges = val;
        savePledges();
        updateAll();
    }
});

// Load saved pledges on start
pledges = loadPledges();
pledgesInput.value = pledges;
updateAll();

/* ---------- Excel Processing ---------- */
fileInput.addEventListener('change', e => {
    errEl.classList.add('hidden');
    const file = e.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
        try{
            const data = new Uint8Array(ev.target.result);
            const workbook = XLSX.read(data, {type:'array'});

            if (workbook.SheetNames.length < 2) throw new Error('Sheet2 not found');
            const sheet = workbook.Sheets[workbook.SheetNames[4]];
            const json = XLSX.utils.sheet_to_json(sheet, {header:1, defval:''});

            const headerRow = json[3];
            const totalColIdx = headerRow.indexOf('Jan - Dec 25');
            if(totalColIdx === -1) throw new Error('TOTAL column not found in Sheet2');

            let total = 0;
            const categoryMap = {};

            for(let i = 4; i < json.length-3; i++){
                const row = json[i];
                const totalVal = parseFloat(row[totalColIdx]);
                if(!isNaN(totalVal) && totalVal > 0) {
                    total += totalVal;

                    const catCell = row[2];
                    const cat = safeTrim(catCell);
                    if(cat){
                        categoryMap[cat] = (categoryMap[cat] || 0) + totalVal;
                    }
                }
            }

            donationsFromFile = total;
            updateAll();
            renderPie(categoryMap);

        }catch(err){
            errEl.textContent = 'Error: '+err.message;
            errEl.classList.remove('hidden');
            console.error(err);
        }
    };
    reader.readAsArrayBuffer(file);
});
</script>
</body>
</html>